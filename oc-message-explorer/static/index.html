<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OC Message Explorer</title>
    <link rel="stylesheet" href="/static/themes/base/base.css">
    <style>
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: var(--bg-primary);
            padding: 8px 16px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            transition: top 0.2s;
        }

        .skip-link:focus {
            top: 0;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1f26;
            --bg-secondary: #222730;
            --bg-tertiary: #2a2f3a;
            --bg-hover: #353b48;
            --text-primary: #f0f2f5;
            --text-secondary: #a0a5ac;
            --text-muted: #6b7178;
            --accent: #4f9cff;
            --accent-hover: #7ab3ff;
            --accent-soft: rgba(79, 156, 255, 0.12);
            --border: #3a404d;
            --border-light: #2f3542;
            --success: #3ab583;
            --danger: #e55858;
            --warning: #dcb16c;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
           sidebar-width: 240px;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            flex-shrink: 0;
            overflow-y: auto;
            transition: width 0.25s ease, opacity 0.25s ease, padding 0.25s ease;
            z-index: 1;
        }

        .sidebar.collapsed {
            width: 0;
            border-right-width: 0;
            opacity: 0;
            padding: 0;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            min-width: 0;
            z-index: 0;
        }

        .main-content-inner {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            transition: padding-left 0.25s ease;
        }

        .sidebar.collapsed ~ .main-content .main-content-inner {
            padding-left: 48px;
        }

        .app-header {
            background: var(--bg-secondary);
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-toggle {
            width: 36px;
            height: 36px;
            min-width: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .app-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-section-title {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            background: linear-gradient(to right, var(--border-light), transparent);
            border-bottom: 1px solid var(--border-light);
        }

        .folder-list {
            list-style: none;
        }

        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
        }

        .tag-cloud-item {
            padding: 8px 14px;
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
        }

        .tag-cloud-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
            color: #ffffff;
        }

        .tag-cloud-item.active {
            background: var(--accent);
            border-color: var(--accent-hover);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(79, 156, 255, 0.4);
        }

        .tag-cloud-item .tag-count {
            font-size: 11px;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .tag-cloud-item .tag-count {
            font-size: 11px;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .todo-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 6px;
            transition: all 0.15s ease;
        }

        .todo-item:hover {
            border-color: var(--accent);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .todo-content {
            flex: 1;
            min-width: 0;
        }

        .todo-text {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .todo-item:hover .todo-text {
            color: var(--text-primary);
        }

        .todo-priority {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .todo-priority.high {
            background: var(--danger);
            color: #ffffff;
        }

        .todo-priority.medium {
            background: var(--warning);
            color: #0d1117;
        }

        .todo-priority.low {
            background: var(--success);
            color: #ffffff;
        }

        .todo-actions {
            display: flex;
            gap: 4px;
        }

        .todo-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .todo-delete:hover {
            background: var(--danger);
            color: #ffffff;
        }

        .sidebar-section {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section-title {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .folder-list {
            list-style: none;
        }

        .folder-item {
            padding: 8px 14px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s ease;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
        }

        .folder-item.active {
            border-left-color: var(--accent);
            background: var(--accent-soft);
            color: var(--text-primary);
            font-weight: 500;
        }

        .folder-item .folder-color {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        .controls {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .btn .btn-icon {
            font-size: 16px;
        }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
        }

        .btn.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }



        .toolbar {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-right {
            margin-left: auto;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-light);
            margin: 0 4px;
        }

        .theme-selector {
            position: relative;
        }

        .more-menu {
            position: relative;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu-item {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.1s ease;
        }

        .dropdown-menu-item:hover {
            background: var(--bg-tertiary);
        }

        .dropdown-menu-item i,
        .dropdown-menu-item span.icon {
            font-size: 16px;
            color: var(--text-secondary);
            width: 20px;
            text-align: center;
        }

        .dropdown-menu-item span.text {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .dropdown-menu-item .shortcut {
            font-size: 12px;
            color: var(--text-muted);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace;
        }

        .dropdown-menu-divider {
            height: 1px;
            background: var(--border-light);
            margin: 6px 0;
        }

        .dropdown-menu-header {
            padding: 8px 14px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toolbar-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .toolbar-btn .icon {
            font-size: 16px;
        }

        .theme-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .theme-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background var(--transition-duration);
        }

        .theme-item:hover {
            background: var(--bg-hover);
        }

        .theme-item.active {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent);
        }

        .theme-preview {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            border: 1px solid var(--border);
        }

        .theme-info {
            flex: 1;
        }

        .theme-name {
            font-size: 14px;
            font-weight: 500;
        }

        .theme-type {
            font-size: 11px;
            color: var(--text-muted);
        }

        .search-box {
            padding: 9px 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 14px;
            width: 280px;
            outline: none;
            transition: all 0.15s ease;
        }

        .search-box:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .search-box::placeholder {
            color: var(--text-muted);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-toggle:hover {
            background: var(--bg-hover);
        }

        .filter-toggle input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .filter-toggle.active {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }

        .tree-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 20px 20px 0;
        }

        .tree-node {
            margin-left: 0;
            padding: 4px 0;
        }

        .tree-root {
            margin-left: 0;
        }

        .node-content {
            display: flex;
            align-items: center;
            padding: 12px 12px 12px 8px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 6px;
            gap: 8px;
        }

        .node-content:hover {
            background: var(--bg-tertiary);
            border-color: var(--border);
        }

        .node-content.selected {
            background: var(--accent-soft);
            border-color: var(--accent);
        }

        .node-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: auto;
            position: relative;
        }

        .node-action-btn {
            padding: 6px 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .node-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .node-action-btn.active {
            color: var(--accent);
            background: var(--accent-soft);
        }

        .node-action-group {
            display: flex;
            position: relative;
            z-index: 1;
        }

        .node-action-group .node-action-btn:not(:first-child) {
            margin-left: -8px;
        }

        .node-action-group .node-action-btn:hover {
            z-index: 10;
        }

        .node-content.prompt-node {
            border-left: 3px solid var(--accent);
        }

        .node-content.response-node {
            border-left: 3px solid var(--warning);
        }

        .node-content.user-node {
            border-left: 3px solid var(--success);
        }

        .node-content.system-node {
            border-left: 3px solid var(--text-muted);
        }

        .node-content.auto-node {
            border-left: 3px solid var(--accent);
            border-left-style: dashed;
        }

        .expand-icon {
            width: 20px;
            text-align: center;
            margin-right: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .node-checkbox {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .edit-area {
            padding: 4px 8px;
            margin-left: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .edit-area:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }

        .edit-area.active {
            background: rgba(88, 166, 255, 0.2);
        }

        .checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            padding: 4px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .checkbox-wrapper:hover {
            background: rgba(79, 156, 255, 0.1);
            border-radius: 4px;
        }

        .checkbox-wrapper:hover .node-checkbox {
            border-color: var(--accent);
        }


        .node-type.prompt {
            background: var(--accent);
            color: #ffffff;
        }

        .node-type.response {
            background: var(--warning);
            color: #0d1117;
        }

        .node-type.user {
            background: var(--success);
            color: #ffffff;
        }

        .node-type.system {
            background: var(--text-muted);
            color: #ffffff;
        }

        .node-type.auto {
            background: var(--accent);
            color: #ffffff;
            opacity: 0.8;
        }

        .node-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
            word-break: break-word;
            white-space: pre-wrap;
        }

        .node-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .node-folder {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .node-folder .folder-color {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .node-timestamp {
            padding: 2px 6px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            font-weight: 500;
            font-size: 11px;
            color: #7ab3ff;
        }

        .node-folder {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .node-folder .folder-color {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .node-timestamp {
            flex-shrink: 0;
        }

        .editor-panel {
            width: 700px;
            min-width: 300px;
            max-width: 1200px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .editor-resize-handle {
            width: 6px;
            background: var(--border);
            cursor: col-resize;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 10;
            transition: background 0.15s ease;
        }

        .editor-resize-handle:hover {
            background: var(--accent);
            width: 8px;
        }

        .editor-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .editor-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: row;
            gap: 16px;
        }

        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .editor-textarea {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 15px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .editor-main .editor-textarea {
            height: 100%;
            min-height: 300px;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .editor-main .form-group {
            margin-bottom: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-main .form-label {
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .editor-actions {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.85);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.15s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: translateY(100px);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-size: 13px;
        }

        .notification.show {
            transform: translateY(0);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
            opacity: 0.6;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 13px;
            color: var(--text-muted);
        }

        .progress-bar {
            width: 300px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .dragging {
            opacity: 0.5;
            background: var(--bg-tertiary);
        }

        .drop-target {
            border: 2px dashed var(--accent);
            background: rgba(88, 166, 255, 0.05);
        }

        .drag-over {
            background: rgba(88, 166, 255, 0.1);
        }

        .combine-modal-content {
            width: 95%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .combine-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .combine-list-sidebar,
        .combine-preview-sidebar {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .combine-list-sidebar {
            width: 350px;
            border-right: 1px solid var(--border);
        }

        .combine-preview-sidebar {
            flex: 1;
        }

.combine-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .combine-sort-controls {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .combine-sort-controls .btn {
            font-size: 12px;
            padding: 6px 10px;
            flex: 1;
            min-width: 80px;
        }

        .combine-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: move;
            transition: all 0.15s ease;
        }

        .combine-item:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .combine-item.combine-dragging {
            opacity: 0.5;
        }

        .combine-item.combine-dragover {
            border: 2px dashed var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }

        .combine-item-drag {
            color: var(--text-muted);
            cursor: move;
            font-size: 14px;
            padding: 4px;
            user-select: none;
        }

        .combine-item-content {
            flex: 1;
            min-width: 0;
        }

        .combine-item-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
            margin-right: 8px;
        }

        .combine-item-type.prompt {
            background: var(--accent);
            color: #ffffff;
        }

        .combine-item-type.response {
            background: var(--warning);
            color: #0d1117;
        }

        .combine-item-text {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .combine-item-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .combine-item-remove:hover {
            background: var(--danger);
            color: #ffffff;
        }

        .combine-actions {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .combined-preview {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin: 8px 12px 12px;
        }

        .combined-preview:empty::before {
            content: 'Preview will appear here';
            color: var(--text-muted);
            font-style: italic;
        }

        .combined-preview h1,
        .combined-preview h2,
        .combined-preview h3,
        .combined-preview h4,
        .combined-preview h5,
        .combined-preview h6 {
            color: var(--text-primary);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .combined-preview h1 { font-size: 2em; }
        .combined-preview h2 { font-size: 1.5em; }
        .combined-preview h3 { font-size: 1.25em; }

        .combined-preview p {
            margin: 0.5em 0;
            line-height: 1.6;
            color: var(--text-primary);
            font-size: 16px;
        }

        .combined-preview code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
        }

        .combined-preview pre {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .combined-preview pre code {
            background: none;
            padding: 0;
        }

        .combined-preview blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 16px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        .combined-preview ul,
        .combined-preview ol {
            margin: 0.5em 0;
            padding-left: 24px;
        }

        .combined-preview li {
            margin: 0.25em 0;
        }

        .combined-preview hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2em 0;
        }

        .combined-preview a {
            color: var(--accent);
            text-decoration: none;
        }

        .combined-preview a:hover {
            text-decoration: underline;
        }

        .combined-preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        .combined-preview th,
        .combined-preview td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .combined-preview th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .optimize-modal {
            max-width: 900px;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }

        .optimizer-section {
            flex: 0 0 auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .optimizer-preview {
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-x: hidden;
        }

        #optimizerPreview {
            max-height: 200px;
            min-height: 100px;
        }

        #optimizerResult {
            height: auto;
            flex: 1;
        }

        #optimizerResult div[style*="padding: 12px"] {
            height: 100%;
            overflow-y: auto;
        }

        .optimizer-preview h1,
        .optimizer-preview h2,
        .optimizer-preview h3,
        .optimizer-preview h4,
        .optimizer-preview h5,
        .optimizer-preview h6 {
            font-size: 1.2em;
            margin: 0.75em 0;
            font-weight: 600;
        }

        .optimizer-preview p {
            margin: 0.5em 0;
        }

        .optimizer-preview code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }

        .optimizer-preview pre {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .optimizer-preview pre code {
            background: none;
            padding: 0;
        }

        .agents-modal-content {
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .agents-preview {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.6;
            margin: 0 12px 12px;
            min-height: 300px;
        }

        .agents-preview h1,
        .agents-preview h2,
        .agents-preview h3,
        .agents-preview h4,
        .agents-preview h5,
        .agents-preview h6 {
            font-size: 1.3em;
            margin: 1em 0 0.5em;
            font-weight: 600;
        }

        .agents-preview h1 { font-size: 2em; }
        .agents-preview h2 { font-size: 1.5em; }
        .agents-preview h3 { font-size: 1.25em; }

        .agents-preview p {
            margin: 0.5em 0;
            line-height: 1.7;
        }

        .agents-preview code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }

        .agents-preview pre {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.75em 0;
        }

        .agents-preview pre code {
            background: none;
            padding: 0;
        }

        .agents-preview ul,
        .agents-preview ol {
            margin: 0.5em 0;
            padding-left: 24px;
        }

        .agents-preview li {
            margin: 0.3em 0;
        }

        .sync-status {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            padding: 8px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .sync-status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-status-message {
            color: var(--text-secondary);
        }

        .sync-status-message.syncing {
            color: var(--accent);
        }

        .sync-status-message.complete {
            color: var(--success);
        }

        .sync-status-message.error {
            color: var(--danger);
        }

        .sync-status-message.cancelled {
            color: var(--text-muted);
        }

        .sync-status-actions {
            display: flex;
            gap: 8px;
        }

        .sync-status-actions .btn {
            padding: 4px 10px;
            font-size: 12px;
        }

        .lock-icon {
            font-size: 16px;
            margin-left: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
        }

        .lock-icon:hover {
            transform: scale(1.1);
        }

        .lock-icon.locked {
            color: var(--accent);
        }

        .lock-icon.unlocked {
            color: var(--text-muted);
        }

        .command-palette {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .command-palette.visible {
            display: block;
        }

        .command-palette-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .command-palette-container {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 90vw;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            animation: commandPaletteIn 0.15s ease;
        }

        @keyframes commandPaletteIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .command-palette-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .command-palette-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            outline: none;
        }

        .command-palette-input:focus {
            border-color: var(--accent);
        }

        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        .command-palette-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background var(--transition-duration);
        }

        .command-palette-item:hover,
        .command-palette-item.active {
            background: var(--bg-hover);
        }

        .command-palette-item-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .command-palette-item-content {
            flex: 1;
            min-width: 0;
        }

        .command-palette-item-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .command-palette-item name mark {
            background: var(--accent);
            color: var(--bg-primary);
            padding: 0 2px;
            border-radius: 2px;
        }

        .command-palette-item-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .command-palette-item-shortcut {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .command-palette-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .command-palette-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .command-palette-empty-text {
            font-size: 15px;
        }

        .command-palette-footer {
            padding: 8px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-palette-footer .command-shortcut {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 6px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 95%; }

        .node-text.loading {
            position: relative;
        }

        .node-text.loading .skeleton-text {
            display: block;
        }

        .optimistic-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9000;
            animation: optimisticSlideIn 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes optimisticSlideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .optimistic-indicator.fade-out {
            animation: optimisticFadeOut 0.3s ease forwards;
        }

        @keyframes optimisticFadeOut {
            to {
                transform: translateY(10px);
                opacity: 0;
            }
        }

        .optimistic-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: optimisticSpin 0.6s linear infinite;
        }

        @keyframes optimisticSpin {
            to { transform: rotate(360deg); }
        }

        .optimistic-text {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

    </style>

</head>
<body>
    <a href="#searchBox" class="skip-link">Skip to search</a>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon">‚è≥</div>
        <div class="loading-text" id="loadingText">Loading OpenChat messages...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait</div>
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header" aria-label="Folders section">Folders</div>
            <div class="controls">
                <button class="btn primary" onclick="reloadData()" aria-label="Reload data" title="Reload (R)">Reload</button>
                <button class="btn" onclick="showNewFolderModal()" aria-label="Create new folder" title="New folder (N)">New</button>
            </div>
            <ul class="folder-list" id="folderList" role="list" aria-label="Folder list">
                <li class="folder-item active" data-folder="all">
                    <div class="folder-name">All Messages</div>
                </li>
            </ul>
            <div class="sidebar-header" style="margin-top: 24px;" aria-label="Tags section">Tags</div>
            <div class="tag-cloud" id="tagCloud" role="group" aria-label="Filter by tags">
                <button class="tag-cloud-item" onclick="clearTagFilter()" role="menuitem" aria-label="Clear all tag filters">Clear All</button>
            </div>

            <div class="sidebar-header" style="margin-top: 24px;" aria-label="Todos section">Todos</div>
            <div class="todo-list" id="todoList" role="list" aria-label="Todo items"></div>
            <div class="controls" style="padding: 0 16px 16px;">
                <input type="text" class="form-input" id="newTodoText" placeholder="Add todo..." style="width: 100%;" aria-label="New todo text">
                <button class="btn primary" onclick="addTodo()" style="width: 100%; margin-top: 8px;" aria-label="Add new todo item" title="Add todo (A)">Add</button>
            </div>
        </div>

    <div class="main-content">
        <div class="main-content-inner">
            <div class="app-header">
                <h1 class="app-title">OC Message Explorer</h1>
            </div>

                <div class="sync-status" id="syncStatus">
                    <div class="sync-status-left">
                        <span id="syncStatusMessage" class="sync-status-message">Ready</span>
                        <span id="syncStatusProgress" style="color: var(--text-muted);"></span>
                    </div>
                    <div class="sync-status-actions" id="syncStatusActions" style="display: none;">
                        <button class="btn" onclick="cancelSync()" id="cancelSyncBtn" aria-label="Cancel background sync" title="Cancel sync (Esc)">Cancel</button>
                    </div>
                </div>




            <div class="toolbar" role="toolbar" aria-label="Main toolbar">
                <input type="text" class="search-box" id="searchBox" placeholder="Search..." oninput="filterMessages()" aria-label="Search messages" aria-controls="treeContainer">
                <button class="toolbar-btn" onclick="toggleOptionsPanel()" id="optionsToggleBtn" aria-expanded="false" aria-controls="optionsPanel" aria-label="Filter options" title="Filters">
                    <span class="icon">üîç</span>
                    <span>Filters</span>
                </button>

                <div id="optionsPanel" style="display: none; flex-direction: column; gap: 8px; padding: 12px; position: absolute; top: 100%; left: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-md); z-index: 1000; min-width: 280px;" role="group" aria-label="Filter options">
                    <div class="dropdown-menu-header">Quick Filters</div>
                    <label class="filter-toggle" id="filterToggle">
                        <input type="checkbox" id="userOnlyFilter" onchange="toggleUserFilter()">
                        <span>User messages only</span>
                    </label>
                    <label class="filter-toggle active" id="emptyToggle">
                        <input type="checkbox" id="hideEmptyResponses" checked onchange="toggleHideEmptyResponses()">
                        <span>Hide empty responses</span>
                    </label>
                    <label class="filter-toggle" id="sortToggle">
                        <input type="checkbox" id="sortAscending" checked onchange="toggleSortOrder()">
                        <span>Newest first</span>
                    </label>
                    <div class="dropdown-menu-divider"></div>
                    <div class="dropdown-menu-header">Date Range</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="date" class="form-input" id="startDate" style="flex: 1;" title="Start date" aria-label="Start date">
                        <input type="date" class="form-input" id="endDate" style="flex: 1;" title="End date" aria-label="End date">
                    </div>
                </div>

                <div class="toolbar-divider"></div>

                <button class="toolbar-btn" onclick="copySelected()" aria-label="Copy selected" title="Copy (Ctrl+C)">
                    <span class="icon">üìã</span>
                    <span class="text">Copy</span>
                </button>
                <button class="toolbar-btn" onclick="showCombineModal()" aria-label="Combine selected" title="Combine">
                    <span class="icon">üîó</span>
                    <span class="text">Combine</span>
                </button>

                <div class="more-menu">
                    <button class="toolbar-btn" id="moreBtn" onclick="toggleMoreMenu()" aria-expanded="false" aria-haspopup="true" aria-label="More actions" title="More options">
                        <span class="icon">‚öôÔ∏è</span>
                        <span class="text">More</span>
                    </button>
                    <div class="dropdown-menu" id="moreMenu" role="menu" aria-label="More actions">
                        <div class="dropdown-menu-header">Actions</div>
                        <button class="dropdown-menu-item" onclick="expandAll()" role="menuitem">
                            <span class="icon">üìÇ</span>
                            <span class="text">Expand All</span>
                        </button>
                        <button class="dropdown-menu-item" onclick="collapseAll()" role="menuitem">
                            <span class="icon">üìÅ</span>
                            <span class="text">Collapse All</span>
                        </button>
                        <div class="dropdown-menu-divider"></div>
                        <button class="dropdown-menu-item" onclick="unselectAll()" role="menuitem">
                            <span class="icon">‚úì</span>
                            <span class="text">Uncheck All</span>
                        </button>
                        <div class="dropdown-menu-divider"></div>
                        <button class="dropdown-menu-item" id="undoMenuItem" onclick="undoRedoManager.undo()" disabled role="menuitem">
                            <span class="icon">‚Ü©Ô∏è</span>
                            <span class="text">Undo</span>
                            <span class="shortcut">Ctrl+Shift+Z</span>
                        </button>
                        <button class="dropdown-menu-item" id="redoMenuItem" onclick="undoRedoManager.redo()" disabled role="menuitem">
                            <span class="icon">‚Ü™Ô∏è</span>
                            <span class="text">Redo</span>
                            <span class="shortcut">Ctrl+Y</span>
                        </button>
                        <div class="dropdown-menu-divider"></div>
                        <div class="dropdown-menu-header">Data</div>
                        <button class="dropdown-menu-item" onclick="exportData()" role="menuitem">
                            <span class="icon">‚¨áÔ∏è</span>
                            <span class="text">Export</span>
                        </button>
                        <button class="dropdown-menu-item" onclick="document.getElementById('importFile').click()" role="menuitem">
                            <span class="icon">‚¨ÜÔ∏è</span>
                            <span class="text">Import</span>
                        </button>
                        <div class="dropdown-menu-divider"></div>
                        <div class="dropdown-menu-header">Settings</div>
                        <button class="dropdown-menu-item" onclick="showSettingsModal()" role="menuitem">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="text">Settings</span>
                        </button>
                        <button class="dropdown-menu-item" onclick="toggleThemePanel()" role="menuitem">
                            <span class="icon">üé®</span>
                            <span class="text">Change Theme</span>
                        </button>
                    </div>
                    <div id="themePanel" style="display: none; position: absolute; top: calc(100% + 4px); right: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; z-index: 1001; min-width: 220px; box-shadow: var(--shadow-md);" role="dialog" aria-label="Select theme">
                        <div class="dropdown-menu-header">Theme</div>
                        <div id="themeList" class="theme-list" role="listbox"></div>
                    </div>
                </div>

                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)" aria-label="Import JSON file">
            </div>

            <div class="tree-container" id="treeContainer" role="tree" aria-label="Messages">
                <div class="empty-state">
                    <h3>No messages</h3>
                    <p>Reload to load your OpenChat history</p>
                </div>
            </div>
        </div>

        <div class="editor-panel" id="editorPanel" style="display: none;">
            <div class="editor-header">
                <button class="close-btn" onclick="closeEditor()" aria-label="Close editor" title="Close (Escape)">‚úï</button>
            </div>
            <div class="editor-content">
                <div class="editor-main">
                    <div class="form-group">
                        <label class="form-label">Raw Message (what you typed)</label>
                        <textarea class="editor-textarea" id="nodeContent" placeholder="Your actual message..." style="height: 100%; min-height: 400px;"></textarea>
                    </div>
                </div>
                <div class="editor-sidebar">
                    <div class="form-group">
                        <label class="form-label">AI Summary (tool output)</label>
                        <textarea class="editor-textarea" id="nodeSummary" placeholder="Tool summary..." style="height: 150px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="nodeType">
                            <option value="user">User</option>
                            <option value="auto">Auto-Generated</option>
                            <option value="system">System</option>
                            <option value="prompt">Prompt</option>
                            <option value="response">Response</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-input" id="nodeTags" placeholder="tag1, tag2, tag3">
                    </div>
                </div>
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="saveNode()" aria-label="Save message changes" title="Save (Ctrl+S)">Save</button>
                <button class="btn" onclick="deleteNode()" aria-label="Delete this message" title="Delete (Del)">Delete</button>
            </div>
        </div>
            </div>
        </div>
    </div>
        </div>

    <div class="modal" id="newFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Folder</h2>
                <button class="close-btn" onclick="hideModal('newFolderModal')" aria-label="Close new folder dialog" title="Close (Escape)">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="folderName">Folder Name</label>
                <input type="text" class="form-input" id="folderName" placeholder="My Folder" aria-label="Folder name">
            </div>
            <div class="form-group">
                <label class="form-label">Folder Color</label>
                <div class="color-picker" id="folderColorPicker" role="radiogroup" aria-label="Choose folder color">
                    <div class="color-option selected" style="background: #58a6ff;" data-color="#58a6ff" role="radio" aria-checked="true" aria-label="Blue color"></div>
                    <div class="color-option" style="background: #238636;" data-color="#238636" role="radio" aria-checked="false" aria-label="Green color"></div>
                    <div class="color-option" style="background: #d29922;" data-color="#d29922" role="radio" aria-checked="false" aria-label="Yellow color"></div>
                    <div class="color-option" style="background: #da3633;" data-color="#da3633" role="radio" aria-checked="false" aria-label="Red color"></div>
                    <div class="color-option" style="background: #a371f7;" data-color="#a371f7" role="radio" aria-checked="false" aria-label="Purple color"></div>
                    <div class="color-option" style="background: #f0883e;" data-color="#f0883e" role="radio" aria-checked="false" aria-label="Orange color"></div>
                </div>
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="createFolder()" aria-label="Create new folder" title="Create (Enter)">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newMessageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Message</h2>
                <button class="close-btn" onclick="hideModal('newMessageModal')" aria-label="Close new message dialog" title="Close (Escape)">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="parentMessageSelect">Parent Message</label>
                <select class="form-select" id="parentMessageSelect" aria-label="Select parent message">
                    <option value="">None (root message)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="newMessageContent">Content</label>
                <textarea class="editor-textarea" id="newMessageContent" placeholder="Enter your content..." style="height: 150px;" aria-label="Message content"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="newMessageTags">Tags (comma-separated)</label>
                <input type="text" class="form-input" id="newMessageTags" placeholder="tag1, tag2, tag3" aria-label="Message tags">
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="saveSettings()" aria-label="Save settings to .env file" title="Save (Ctrl+S)">Save to .env</button>
                <button class="btn" onclick="testApiKey()" aria-label="Test API key connection" title="Test connection">Test Connection</button>
                <button class="btn" onclick="loadAgentsContent()" aria-label="View AGENTS.md documentation" title="View documentation">View AGENTS.md</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 650px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2>Settings</h2>
                <button class="close-btn" onclick="hideModal('settingsModal')" aria-label="Close settings dialog" title="Close (Escape)">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
                <input type="password" class="form-input" id="openaiApiKey" placeholder="sk-..." aria-label="Enter your OpenAI API key">
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">Your API key is stored locally only and in .env file</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="openaiBaseUrl">OpenAI Base URL (optional)</label>
                <input type="text" class="form-input" id="openaiBaseUrl" placeholder="https://api.openai.com/v1" aria-label="Enter custom OpenAI base URL">
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">Custom OpenAI-compatible API endpoint (leave blank for default)</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="anthropicApiKey">Anthropic API Key (optional)</label>
                <input type="password" class="form-input" id="anthropicApiKey" placeholder="sk-ant-..." aria-label="Enter your Anthropic API key">
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">For Claude models</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="aiProvider">AI Provider</label>
                <select class="form-select" id="aiProvider" aria-label="Select AI provider">
                    <option value="auto">Auto-select</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                </select>
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">Auto-select will use OpenAI if available, otherwise Anthropic</small>
            </div>
            <div class="form-group" id="aiModelGroup" style="display: none;">
                <label class="form-label" for="aiModel">AI Model</label>
                <select class="form-select" id="aiModel" aria-label="Select AI model">
                </select>
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">Select model for the chosen provider</small>
            </div>
            <div class="form-group" id="modelSelectGroup" style="display: none;">
                <label class="form-label" for="openaiModel">Model</label>
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                    <input type="text" class="form-input" id="openaiModelFilter" placeholder="Filter models..." style="flex: 1;" aria-label="Filter model list">
                    <button class="btn" onclick="clearModelFilter()" style="padding: 10px 12px;" aria-label="Clear model filter" title="Clear filter">‚úï</button>
                </div>
                <select class="form-select" id="openaiModel" style="max-height: 200px;" aria-label="Select OpenAI model">
                    <option value="">Select a model</option>
                </select>
                <button class="btn" id="refreshModelsBtn" onclick="fetchModels()" style="margin-top: 8px;" aria-label="Refresh available models" title="Refresh model list (R)">Refresh Models</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="optimizationPrompt">Optimization Prompt</label>
                <textarea class="editor-textarea" id="optimizationPrompt" style="height: 180px;" placeholder="Custom prompt for optimization..." aria-label="Custom optimization prompt">First, read and understand the AGENTS.md file which contains project-specific guidelines, coding conventions, and development practices.

Then, combine these prompts into a single, task-oriented prompt that will direct you to:

1. Verify the existence of the components described in the prompts within the project codebase
2. If any component does not exist, recreate it following the guidelines from AGENTS.md
3. Ensure all code follows the project's coding conventions and best practices
4. Maintain consistency with the existing project structure and patterns

Base your implementation decisions on the guidance in AGENTS.md, prioritizing:
- Code quality and maintainability
- Adherence to project conventions
- Proper documentation and commenting
- Type safety and error handling</textarea>
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">
                    This prompt is used to combine multiple selected prompts into a single task-oriented prompt for verification and recreation of project components.
                </small>
            </div>
            <div class="form-group">
                <label class="form-label" for="projectPath">Project Path</label>
                <input type="text" class="form-input" id="projectPath" placeholder="Path to project directory" aria-label="Enter project directory path">
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">
                    Absolute or relative path to the project directory. Used for reading AGENTS.md.
                </small>
            </div>
            <div class="form-group">
                <label class="form-label" for="agentsPath">AGENTS.md Path</label>
                <input type="text" class="form-input" id="agentsPath" placeholder="Path to AGENTS.md" aria-label="Enter AGENTS.md file path">
                <small style="color: var(--text-muted); font-size: 13px; margin-top: 6px; display: block;">
                    Path to AGENTS.md file. Can be relative to project path or absolute.
                </small>
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="saveSettings()" aria-label="Save settings to .env file" title="Save (Ctrl+S)">Save to .env</button>
                <button class="btn" onclick="testApiKey()" aria-label="Test API key connection" title="Test connection">Test Connection</button>
                <button class="btn" onclick="loadAgentsContent()" aria-label="View AGENTS.md documentation" title="View documentation">View AGENTS.md</button>
            </div>
        </div>
    </div>

    <div class="modal" id="optimizeModal">
        <div class="modal-content optimize-modal" style="width: 900px; max-height: 95vh;">
            <div class="modal-header">
                <h2>Optimize Prompts with AI</h2>
                <button class="close-btn" onclick="hideModal('optimizeModal')" aria-label="Close optimize dialog" title="Close (Escape)">&times;</button>
            </div>
            <div class="optimizer-section" style="flex: 0 0 auto;">
                <label class="form-label">Template</label>
                <select class="form-select" id="aiTemplate" onchange="updateTemplateDescription()">
                    <option value="optimize">Optimize Prompts</option>
                    <option value="summarize">Summarize Conversation</option>
                    <option value="expand">Expand and Elaborate</option>
                    <option value="refine">Refine and Polish</option>
                    <option value="extract">Extract Key Points</option>
                </select>
                <div id="templateDescription" style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Optimize AI prompts for clarity and effectiveness</div>
            </div>
            <div class="form-group" style="flex: 0 0 auto; max-height: 200px;">
                <label class="form-label">Combined Text</label>
                <div class="optimizer-preview" id="optimizerPreview"></div>
            </div>
            <div class="form-group" style="flex: 1 1 auto; overflow: hidden; display: flex; flex-direction: column; padding: 16px 0 0;">
                <label class="form-label">Optimized Result</label>
                <div class="optimizer-preview" id="optimizerResult" style="height: 100%;">
                    <div style="color: var(--text-muted); text-align: center; padding: 40px;">
                        Click "Optimize" to combine your notes
                    </div>
                </div>
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="optimizePrompts()" aria-label="Optimize prompts using AI" title="Optimize (Enter)">Optimize</button>
                <button class="btn" onclick="copyOptimizedResult()" id="copyOptimizedBtn" style="display: none;" aria-label="Copy optimized result to clipboard" title="Copy result (Ctrl+C)">Copy Result</button>
            </div>
        </div>
    </div>

    <div class="modal" id="agentsContentModal">
        <div class="modal-content agents-modal-content">
            <div class="modal-header">
                <h2>AGENTS.md Content</h2>
                <button class="close-btn" onclick="hideModal('agentsContentModal')" aria-label="Close AGENTS.md viewer" title="Close (Escape)">&times;</button>
            </div>
            <div class="agents-preview" id="agentsPreview" role="region" aria-label="AGENTS.md documentation content">
                <div style="color: var(--text-muted); text-align: center; padding: 40px;">Loading...</div>
            </div>
            <div class="editor-actions">
                <button class="btn primary" onclick="copyAgentsContent()" aria-label="Copy AGENTS.md to clipboard" title="Copy to clipboard (Ctrl+C)">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script src="/static/marked.min.js"></script>
    <script src="/static/theme-engine.js"></script>
    <script src="/static/command-palette.js"></script>
    <script src="/static/optimistic-ui.js"></script>
    <script src="/static/undo-redo.js"></script>
    <script src="/static/ai-workflow.js"></script>
    <script src="/static/app.js"></script>

</body>
</html>
